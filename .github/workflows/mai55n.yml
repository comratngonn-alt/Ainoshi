name: Secure Access - macOS

on:
  workflow_dispatch:

jobs:
  secure-access-macos:
    # 1. Thay đổi runs-on thành macos-latest (hoặc macos-14, macos-13...)
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Show Runner Information
        # Lệnh Shell cơ bản trên macOS
        run: |
          echo "Current User: $(whoami)"
          echo "macOS Version: $(sw_vers -productVersion)"
          # Tailscale thường đã được cài sẵn
          if command -v tailscale &> /dev/null; then
              echo "Tailscale is pre-installed."
          else
              echo "Tailscale is NOT pre-installed. Installation required (complex on runner)."
          fi

      # Bỏ qua bước Configure Core RDP Settings (không áp dụng)
      # Bỏ qua bước Create RDP User (không áp dụng)
      # Bỏ qua bước Install Tailscale (thường đã cài sẵn)

      - name: Establish Tailscale Connection
        # 2. Thay đổi lệnh PowerShell thành lệnh Shell/Bash
        run: |
          # Đường dẫn lệnh Tailscale trên macOS
          TS_CMD="/usr/local/bin/tailscale"
          
          # Bring up Tailscale with the provided auth key and set a unique hostname
          # Sử dụng biến môi trường secrets.TAILSCALE_AUTH_KEY
          $TS_CMD up --auth-key=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-macos-$GITHUB_RUN_ID --ssh
          
          # Wait for Tailscale to assign an IP
          TS_IP=""
          RETRYS=0
          while [ -z "$TS_IP" ] && [ $RETRYS -lt 10 ]; do
              # Lấy địa chỉ IPv4
              TS_IP=$($TS_CMD ip -4)
              sleep 5
              RETRYS=$((RETRYS+1))
          done
          
          if [ -z "$TS_IP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
      
      - name: Display Connection Info & Maintain Connection
        # 3. Thay đổi lệnh PowerShell thành lệnh Shell/Bash
        run: |
          echo "TAILSCALE_IP=$TAILSCALE_IP"
          
          echo -e "\n=== SECURE ACCESS INFO ==="
          echo "Address: $TAILSCALE_IP"
          echo "Protocol: SSH (Port 22)"
          echo "Username: $(whoami) (or customize)"
          echo "==========================\n"
          
          echo "Use 'ssh $(whoami)@$TAILSCALE_IP' to connect."
          echo "To access GUI, you might need to use VNC or SSH with X11 forwarding."
          
          # Keep runner active indefinitely (or until manually cancelled)
          while true; do
              echo "[$(date)] Runner Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
